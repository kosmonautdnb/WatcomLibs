#include "GL.H"
#include "types.hpp"
#include "charset.hpp"
#include <stdlib.h>
#include <math.h>

extern Letter charset[];

Letter* getLetter(char s) {
    Letter* l = charset;
    while (l->letter != 0xff) {
        if (l->letter == s)
            return l;
        l++;
    }
    return l;
}

static GLboolean newXYZ = GL_FALSE;
static bool isVisible = false;
static bool shouldClip = false;

void glDrawText2(float scale, float xp, float yp, float zp, int xa, int ya, const char *text, uint32_t color, float anchorX, float anchorY) {
  if (text == NULL || (!isVisible)) 
    return;
  int width2 = 0;
  int width = 0;
  int height = 6;
  const char *s2 = text;
  while(*s2!=0) {
    if (*s2 == '\n') {height += 6;width2=0;}
    Letter *l = getLetter(*s2);
    width2 += l->preAddX + l->width + l->postAddX;
    if (width2 > width) width = width2;
    s2++;
    if (*s2 == 0) break;
    width2 += 1;
  }
  const char *s = text;
  int x2 = -width * anchorX;
  int y2 = -height * anchorY;
  int x3 = x2;
  while(*s!=0) {
    Letter *l = getLetter(*s);
    if (*s == '\n') {
      x2 = x3;
      y2 += 6;
      s++;
      continue;
    }
    for (int y = 0; y < l->height; y++) {
      for (int x = 0; x < l->width; x++) {
        int x3 = x2 + x + l->preAddX + xa;
        int y3 = y2 + y + l->preAddY + ya;
        if (l->bitmap[x+y*l->width]!='0') {
          int x0 = (int)floor(x3 * scale);
          int y0 = (int)floor(y3 * scale);
          int x1 = (int)floor((x3+1) * scale);
          int y1 = (int)floor((y3+1) * scale);
          for (int y4 = y0; y4 < y1; y4++) {
            for (int x4 = x0; x4 < x1; x4++) {
              if (!glPixel(newXYZ,xp,yp,zp,x4,y4,color)) {
                if (shouldClip) {
                  isVisible = false;
                  return;
                }
              }
              newXYZ = false;
            }
          }
        }
      }
    }
    x2 += l->preAddX + l->width + l->postAddX + 1;
    s++;
  }
}

void glDrawText(bool clip,float xp, float yp, float zp, const float scale, const char *text, uint32_t color, float anchorX, float anchorY) {
  newXYZ = true;
  isVisible = true;
  shouldClip = clip;
  bool outlined = true;
  if (outlined) {
    glDrawText2(scale,xp,yp,zp,-1,0,text,0xff000000,anchorX,anchorY);
    glDrawText2(scale,xp,yp,zp,+1,0,text,0xff000000,anchorX,anchorY);
    glDrawText2(scale,xp,yp,zp,0,-1,text,0xff000000,anchorX,anchorY);
    glDrawText2(scale,xp,yp,zp,0,+1,text,0xff000000,anchorX,anchorY);
  }
  glDrawText2(scale,xp,yp,zp,0,0,text,color,anchorX,anchorY);
  newXYZ = false;
}

Letter charset[] = {
    {' ',2,5,0,0,0,0,
        "00"
        "00"
        "00"
        "00"
        "00"
    },
    {'0',4,5,0,0,0,0,
        "0110"
        "1001"
        "1001"
        "1001"
        "0110"
    },
    {'1',2,5,0,0,0,0,
        "01"
        "11"
        "01"
        "01"
        "01"
    },
    {'2',4,5,0,0,0,0,
        "0110"
        "1001"
        "0010"
        "0100"
        "1111"
    },
    {'3',4,5,0,0,0,0,
        "1110"
        "0001"
        "0110"
        "0001"
        "1110"
    },
    {'4',4,5,0,0,0,0,
        "1001"
        "1001"
        "1111"
        "0001"
        "0001"
    },
    {'5',4,5,0,0,0,0,
        "1111"
        "1000"
        "1110"
        "0001"
        "1110"
    },
    {'6',4,5,0,0,0,0,
        "0111"
        "1000"
        "1110"
        "1001"
        "0110"
    },
    {'7',4,5,0,0,0,0,
        "1111"
        "0001"
        "0010"
        "0100"
        "0100"
    },
    {'8',4,5,0,0,0,0,
        "0110"
        "1001"
        "0110"
        "1001"
        "0110"
    },
    {'9',4,5,0,0,0,0,
        "0110"
        "1001"
        "0111"
        "0001"
        "1110"
    },
    {'A',4,5,0,0,0,0,
        "0110"
        "1001"
        "1111"
        "1001"
        "1001"
    },
    {'B',4,5,0,0,0,0,
        "1110"
        "1001"
        "1110"
        "1001"
        "1110"
    },
    {'C',4,5,0,0,0,0,
        "0111"
        "1000"
        "1000"
        "1000"
        "0111"
    },
    {'D',4,5,0,0,0,0,
        "1110"
        "1001"
        "1001"
        "1001"
        "1110"
    },
    { 'E',4,5,0,0,0,0,
        "1111"
        "1000"
        "1110"
        "1000"
        "1111"
    },
    { 'F',4,5,0,0,0,0,
        "1111"
        "1000"
        "1110"
        "1000"
        "1000"
    },
    { 'G',4,5,0,0,0,0,
        "0111"
        "1000"
        "1011"
        "1001"
        "0110"
    },
    { 'H',4,5,0,0,0,0,
        "1001"
        "1001"
        "1111"
        "1001"
        "1001"
    },
    { 'I',1,5,0,0,0,0,
        "1"
        "1"
        "1"
        "1"
        "1"
    },
    { 'J',4,5,0,0,0,0,
        "1111"
        "0001"
        "0001"
        "1001"
        "0110"
    },
    { 'K',4,5,0,0,0,0,
        "1001"
        "1001"
        "1110"
        "1001"
        "1001"
    },
    { 'L',4,5,0,0,0,0,
        "1000"
        "1000"
        "1000"
        "1000"
        "1111"
    },
    { 'M',5,5,0,0,0,0,
        "11011"
        "10101"
        "10001"
        "10001"
        "10001"
    },
    { 'N',4,5,0,0,0,0,
        "1001"
        "1101"
        "1011"
        "1001"
        "1001"
    },
    { 'O',4,5,0,0,0,0,
        "0110"
        "1001"
        "1001"
        "1001"
        "0110"
    },
    { 'P',4,5,0,0,0,0,
        "1110"
        "1001"
        "1110"
        "1000"
        "1000"
    },
    { 'Q',4,6,0,0,0,0,
        "0110"
        "1001"
        "1001"
        "1011"
        "0111"
        "0001"
    },
    { 'R',4,5,0,0,0,0,
        "1110"
        "1001"
        "1110"
        "1001"
        "1001"
    },
    { 'S',4,5,0,0,0,0,
        "0111"
        "1000"
        "0110"
        "0001"
        "1110"
    },
    { 'T',5,5,0,0,0,0,
        "11111"
        "00100"
        "00100"
        "00100"
        "00100"
    },
    { 'U',4,5,0,0,0,0,
        "1001"
        "1001"
        "1001"
        "1001"
        "0111"
    },
    { 'V',4,5,0,0,0,0,
        "1001"
        "1001"
        "1001"
        "0101"
        "0011"
    },
    { 'W',5,5,0,0,0,0,
        "10001"
        "10001"
        "10101"
        "10101"
        "01010"
    },
    { 'X',4,5,0,0,0,0,
        "1001"
        "1001"
        "0110"
        "1001"
        "1001"
    },
    { 'Y',5,5,0,0,0,0,
        "10001"
        "01010"
        "00100"
        "00100"
        "00100"
    },
    { 'Z',4,5,0,0,0,0,
        "1111"
        "0001"
        "0010"
        "0100"
        "1111"
    },
    { 'Ä',4,7,0,0,0,-2,
        "1001"
        "0000"
        "0110"
        "1001"
        "1111"
        "1001"
        "1001"
    },
    { 'Ö',4,7,0,0,0,-2,
        "1001"
        "0000"
        "0110"
        "1001"
        "1001"
        "1001"
        "0110"
    },
    { 'Ü',4,7,0,0,0,-2,
        "1001"
        "0000"
        "1001"
        "1001"
        "1001"
        "1001"
        "0111"
    },
    { 'a',4,5,0,0,0,0,
        "0110"
        "0001"
        "0111"
        "1001"
        "1111"
    },
    { 'b',4,5,0,0,0,0,
        "1000"
        "1000"
        "1110"
        "1001"
        "1110"
    },
    { 'c',3,5,0,0,0,0,
        "000"
        "011"
        "100"
        "100"
        "011"
    },
    { 'd',4,5,0,0,0,0,
        "0001"
        "0001"
        "0111"
        "1001"
        "0111"
    },
    { 'e',4,5,0,0,0,0,
        "0110"
        "1001"
        "1111"
        "1000"
        "0111"
    },
    { 'f',3,5,0,0,0,0,
        "011"
        "100"
        "110"
        "100"
        "100"
    },
    { 'g',4,6,0,0,0,1,
        "0111"
        "1001"
        "1001"
        "1111"
        "0001"
        "0110"
    },
    { 'h',4,5,0,0,0,0,
        "1000"
        "1000"
        "1110"
        "1001"
        "1001"
    },
    { 'i',1,5,0,0,0,0,
        "1"
        "0"
        "1"
        "1"
        "1"
    },
    { 'j',3,6,0,0,0,0,
        "001"
        "000"
        "011"
        "001"
        "101"
        "011"
    },
    { 'k',3,5,0,0,0,0,
        "100"
        "101"
        "110"
        "101"
        "101"
    },
    { 'l',2,5,0,0,0,0,
        "10"
        "10"
        "10"
        "10"
        "01"
    },
    { 'm',5,5,0,0,0,0,
        "00000"
        "01010"
        "10101"
        "10001"
        "10001"
    },
    { 'n',3,5,0,0,0,0,
        "000"
        "110"
        "101"
        "101"
        "101"
    },
    { 'o',4,5,0,0,0,0,
        "0000"
        "0110"
        "1001"
        "1001"
        "0110"
    },
    { 'p',4,5,0,0,0,1,
        "1110"
        "1001"
        "1001"
        "1110"
        "1000"
    },
    { 'q',4,6,0,0,0,0,
        "0000"
        "0110"
        "1001"
        "1011"
        "0111"
        "0001"
    },
    { 'r',3,5,0,0,0,0,
        "000"
        "011"
        "100"
        "100"
        "100"
    },
    { 's',3,5,0,0,0,0,
        "000"
        "100"
        "110"
        "001"
        "110"
    },
    { 't',3,5,0,0,0,0,
        "010"
        "111"
        "010"
        "010"
        "001"
    },
    { 'u',4,5,0,0,0,0,
        "0000"
        "1001"
        "1001"
        "1001"
        "0111"
    },
    { 'v',4,5,0,0,0,0,
        "0000"
        "1001"
        "1001"
        "0101"
        "0010"
    },
    { 'w',5,5,0,0,0,0,
        "00000"
        "10001"
        "10001"
        "10101"
        "01010"
    },
    { 'x',4,5,0,0,0,0,
        "0000"
        "1001"
        "0110"
        "1001"
        "1001"
    },
    { 'y',4,6,0,0,0,1,
        "1001"
        "1001"
        "1001"
        "0111"
        "0001"
        "0110"
    },
    { 'z',4,5,0,0,0,0,
        "0000"
        "1111"
        "0010"
        "0100"
        "1111"
    },
    { 'ä',4,7,0,0,0,-2,
        "1001"
        "0000"
        "0110"
        "0001"
        "0111"
        "1001"
        "1111"
    },
    { 'ö',4,6,0,0,0,-1,
        "1001"
        "0000"
        "0110"
        "1001"
        "1001"
        "0110"
    },
    { 'ü',4,6,0,0,0,-1,
        "1001"
        "0000"
        "1001"
        "1001"
        "1001"
        "0110"
    },
    { ',',2,5,0,0,0,0,
        "00"
        "00"
        "00"
        "01"
        "10"
    },
    { '.',1,5,0,0,0,0,
        "0"
        "0"
        "0"
        "0"
        "1"
    },
    { ':',1,5,0,0,0,0,
        "0"
        "1"
        "0"
        "1"
        "0"
    },
    { ';',2,5,0,0,0,0,
        "00"
        "01"
        "00"
        "01"
        "10"
    },
    { '(',2,5,0,0,0,0,
        "01"
        "10"
        "10"
        "10"
        "01"
    },
    { ')',2,5,0,0,0,0,
        "10"
        "01"
        "01"
        "01"
        "10"
    },
    { '[',2,5,0,0,0,0,
        "11"
        "10"
        "10"
        "10"
        "11"
    },
    { ']',2,5,0,0,0,0,
        "11"
        "01"
        "01"
        "01"
        "11"
    },
    { '!',1,5,0,0,0,0,
        "1"
        "1"
        "1"
        "0"
        "1"
    },
    { '?',4,5,0,0,0,0,
        "1110"
        "0001"
        "0110"
        "0000"
        "0100"
    },
    { '=',3,5,0,0,0,0,
        "000"
        "111"
        "000"
        "111"
        "000"
    },
    { '-',3,5,0,0,0,0,
        "000"
        "000"
        "111"
        "000"
        "000"
    },
    { '+',3,5,0,0,0,0,
        "000"
        "010"
        "111"
        "010"
        "000"
    },
    { '_',4,5,0,0,0,0,
        "0000"
        "0000"
        "0000"
        "0000"
        "1111"
    },
    { '>',2,5,0,0,0,0,
        "00"
        "10"
        "01"
        "10"
        "00"
    },
    { '<',2,5,0,0,0,0,
        "00"
        "01"
        "10"
        "01"
        "00"
    },
    { '\"',3,5,0,0,0,0,
        "101"
        "100"
        "000"
        "000"
        "000"
    },
    { '\'',1,5,0,0,0,0,
        "1"
        "0"
        "0"
        "0"
        "0"
    },
    { '*',3,5,0,0,0,0,
        "000"
        "101"
        "010"
        "101"
        "000"
    },
    { '\\',3,5,0,0,0,0,
        "100"
        "100"
        "010"
        "010"
        "001"
    },
    { '/',3,5,0,0,0,0,
        "001"
        "010"
        "010"
        "100"
        "100"
    },
    { '$',4,5,0,0,0,0,
        "0111"
        "1010"
        "0110"
        "0011"
        "1110"
    },
    { '%',5,5,0,0,0,0,
        "11001"
        "11010"
        "00100"
        "01011"
        "10011"
    },
    { '&',5,5,-1,0,0,0,
        "00110"
        "01000"
        "00110"
        "01001"
        "10110"
    },
    { '#',5,5,0,0,0,0,
        "01010"
        "11111"
        "01010"
        "11111"
        "01010"
    },
    { '~',5,5,0,0,0,0,
        "01001"
        "10110"
        "00000"
        "00000"
        "00000"
    },
    { '|',1,5,0,0,0,0,
        "1"
        "1"
        "0"
        "1"
        "1"
    },
    { '^',3,5,0,0,0,0,
        "010"
        "101"
        "000"
        "000"
        "000"
    },
    { '°',3,5,0,0,0,0,
        "010"
        "101"
        "010"
        "000"
        "000"
    },
    { '{',3,7,0,0,0,-1,
        "001"
        "010"
        "010"
        "100"
        "010"
        "010"
        "001"
    },
    { '}',3,7,0,0,0,-1,
        "100"
        "010"
        "010"
        "001"
        "010"
        "010"
        "100"
    },
    { '@',4,5,0,0,0,0,
        "0110"
        "1101"
        "1001"
        "1111"
        "0110"
    },
    { '§',4,5,0,0,0,0,
        "0111"
        "1000"
        "0110"
        "0101"
        "1110"
    },
    { 'ß',4,5,0,0,0,0,
        "0110"
        "1001"
        "1010"
        "1001"
        "1010"
    },
    { (char)'\n',0,0,0,0,0,0,
        ""
    },
    { (char)'\t',1,6,0,0,0,0,
      "1"
      "0"
      "1"
      "1"
      "0"
      "1"
    },
    { (char)0xff,1,6,0,0,0,0,
        "0"
        "1"
        "0"
        "1"
        "0"
        "1"
    }
};